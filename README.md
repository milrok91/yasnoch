# Astro Weather Bot — Noginsky District (Telegram)

Бот присылает каждый день в 15:00 МСК сводку для предстоящей ночи: есть ли окна для астрофото (по средней оценке облачности и вероятности осадков из нескольких источников).

## Что умеет
- Агрегирует **Open-Meteo** и **OpenWeather** (если задан ключ) по координатам Ногинского района (по умолчанию 55.85, 38.45).
- Считает «ночь» как промежуток между условным астрономическим сумерком и рассветом (прибл. ±90 мин от заката/восхода).
- Счёт «ясных часов»: средняя облачность ≤ `CLOUD_THRESHOLD` и вероятность осадков ≤ `PRECIP_THRESHOLD`.
- Ежедневное уведомление в 15:00 МСК; ручная команда `/now`.

## Быстрый старт (локально)

1. Создайте бота в @BotFather, получите `TELEGRAM_TOKEN`.
2. Скопируйте `.env.example` → `.env` и заполните токен (и при желании `OPENWEATHER_API_KEY`).
3. Установите зависимости:
   ```bash
   python -m venv .venv && . .venv/bin/activate
   pip install -r requirements.txt
   ```
4. Запуск:
   ```bash
   python app.py
   ```
5. В Telegram: найдите вашего бота, нажмите **Start**. Бот сохранит ваш chat_id и будет присылать ежедневные отчёты.

## Docker

```bash
docker build -t astro-weather-bot .
docker run -d --name astro-bot --env-file .env astro-weather-bot
```

## Переменные окружения

- `TELEGRAM_TOKEN` — токен вашего бота.
- `OPENWEATHER_API_KEY` — ключ OpenWeather (необязателен).
- `LAT`, `LON` — координаты локации.
- `CLOUD_THRESHOLD` (35), `PRECIP_THRESHOLD` (20) — пороги ясности.
- `MIN_WINDOW_HOURS` (1.0) — минимальная длина окна.
- `TIMEZONE` — по умолчанию `Europe/Moscow`.
- `DAILY_NOTIFY_HOUR`, `DAILY_NOTIFY_MINUTE` — время дневного отчёта.
- `CHAT_DB` — файл, где хранятся chat_id пользователей.

## Команды

- `/start` — зарегистрировать чат и получить подсказку.
- `/now` — мгновенный прогноз на предстоящую ночь.
- `/setthresholds <облачн%> <осадки%>` — сменить пороги, напр. `/setthresholds 40 20`.

## Заметки по качеству прогноза

- Можно добавить другие источники (например, Tomorrow.io) в `providers.py` по аналогии.
- Для более точных астросумерек внедрите расчёт с депрессией -18° (см. astral).
- При отсутствии интернета бот отправит «Нет данных…».

## Обновление/сервис

- Желательно запускать как systemd-сервис или через Docker + автоперезапуск.
- Если бот не пишет: убедитесь, что вы нажали /start и что процесс жив.
